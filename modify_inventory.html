<!DOCTYPE html>

<head>
    <meta http-equiv="Permissions-Policy" content="interest-cohort=()">
    <title>WebPOS - Modify Inventory</title>
    <link rel="icon" href="png/logo.png">
    <link rel="icon" href="png/logo.png">
    <link rel="icon" href="png/logo.png">
    <link rel="stylesheet" href="general.css">
    <style>
        .content {
            font-size: 20px;
            font-family: Arial, Helvetica, sans-serif;
            overflow: hidden;
            position: relative;
            height: 100%;
            grid-area: main;
        }

        .serviceBorder {
            border: 1px solid #dadada;
            font-size: 20px;
            padding: 5px 7px 5px 7px;
            text-align: center;
        }

        .serviceBorder:nth-child(2) {
            width: 50px;
        }

        .inputBox {
            font-size: 20px;
            font-family: Arial, Helvetica, sans-serif;
            text-align: center;
            height: 100%;
            width: 100%;
            padding: 0;
            border: 0;
            border-bottom: 1px solid lightgray;
            outline: 0;
            transition: all 0.2s linear;
        }

        .inputBox:hover {
            border-bottom: 1px solid gray;
        }

        .inputBox:focus {
            border-bottom: 1px solid black;
        }

        .updateButton {
            transition: all 0.1s linear;
        }

        .updateButton:hover {
            background-color: rgb(250, 250, 250);
        }

        .updateButton:active {
            background-color: rgb(240, 240, 240);
        }

        .label {
            display: inline-block;
            vertical-align: text-bottom;
            border: 1px solid lightgray;
            border-radius: 22px;
            text-align: center;
            height: 22px;
            width: 22px;
            margin-left: 5%;
            margin-right: 10px;
        }
    </style>
</head>

<body>

    <div id="loading"
        style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); height: 20px; width: 20px; border: rgb(0, 0, 0, 0.6) none 10px; border-top: solid; border-radius: 20px; z-index: 1;">
    </div>

    <div class="body">

        <div id="menu"></div>

        <div id="detail" style="grid-area: header;">
            <div id="Title" class="detail" style="font-size: min(8vw, 50px);">MODIFY INVENTORY</div>
            <div class="detail" style="position: absolute; z-index: 3; right: 30px; white-space: nowrap;">
                <div id="accStatus" style="position: absolute;"></div>
                <div id="Account"
                    style="z-index: 3; font-size: min(4vw, 20px); position: relative; background-color: white;">
                    [Account]</div>
            </div>
        </div>

        <div id="main" class="content">
            <div style="margin: 10px; margin-bottom: 30px; text-align: right;">
                <label style="padding-right: 7%;">
                    <span class="label"
                        style="border: 0; vertical-align: top; border-bottom: 1px solid gray; border-radius: 0; color: gray; font-family: 'Times New Roman', Times, serif;">T</span>Editable
                    <span class="label">+</span>Add
                    <span class="label" style="color: red;">x</span>Remove
                </label>
            </div>
            <div id="scroll">
                <table id="services"
                    style="border-collapse: collapse; position: relative; left: 50%; transform: translate(-50%, 0%); user-select: none; margin: -1px;">
                </table>
            </div>
        </div>

    </div>

</body>

<!-- Import Menu Bar -->
<script type="text/javascript" src="menu.js"></script>

<script>

    var loading;

    //Start up
    window.onload = function () {
        //Get data from session storage
        var user = sessionStorage.getItem("user");
        if (user) {
            document.getElementById("Account").innerHTML = user;

            // Loading animation
            var rotate = 0;
            loading = setInterval(() => {
                document.getElementById("loading").style.transform = ("translate(-50%, -50%) rotate(" + rotate + "deg)");
                rotate += 10;
                if (rotate > 360) {
                    rotate = 0;
                }
            }, 10);

            setTimeout(() => {
                clearInterval(loading);
            }, 3000);

        } else {

            //session outdated
            var info = "Session outdated.\n Please login again.";
            document.body.innerHTML += `
            <div style="position: absolute; left: 0px; top: 0px; height: 100%; width: 100%; z-index: 1;">
                <div style="font-size: 30px; white-space: pre-line; text-align: center; position: absolute; top: 50%; left: 50%; padding: 10px 30px 10px 30px; transform: translate(-50%, -50%); border: 1px solid rgba(0, 0, 0, 0.6); background-color: rgba(255, 255, 255, 0.6);"
                >${info}
                    <button type="button" onclick="window.location.href = 'staffcode.html'">Return to Login</button>
                </div>
            </div>
        `;

        }

    };

</script>

<script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";

    //createUserWithEmailAndPassword
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import { getDatabase, set, ref, update, onValue, push, remove } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries

    // Your web app's Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyDmYAF5VJ0RntbtrfJ_4Sk9syHYGKev4nw",
        authDomain: "webpos24-e0eb3.firebaseapp.com",
        databaseURL: "https://webpos24-e0eb3-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "webpos24-e0eb3",
        storageBucket: "webpos24-e0eb3.firebasestorage.app",
        messagingSenderId: "544188889423",
        appId: "1:544188889423:web:9d7c59723cde33292bad3a"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const database = getDatabase(app);

    // If logged out somewhere
    onAuthStateChanged(auth, (user) => {
        if (user) {
            // User is signed in, see docs for a list of available properties
            // https://firebase.google.com/docs/reference/js/auth.user
            console.log("[User Credential] " + user.uid);

            // Remove loading animation
            clearInterval(loading);
            document.getElementById("loading").remove();

            // ...
        } else {
            // User is signed out
            // ...
            alert("Oh no, you have been signed out.");
            window.location.href = "login.html"
        }
    });

    // Modify Inventory Table
    onValue(ref(database, 'services/categories'), (snapshot) => {

        //Initialise table
        document.getElementById("scroll").style = "position: relative; left: 50%; transform: translateX(-50%); overflow-y: auto; height: 80%; width: fit-content; border: 1px solid #dadada;";
        document.getElementById("services").innerHTML = `
            <tr class="serviceBorder" style="position: sticky; top: 0; transform: translateY(-1px); box-shadow: 0 0px 0.5px 1px #dadada; background-color: white; user-select: none; z-index: 1;">
                <th class="serviceBorder" style="min-width: 40px;"></th>
                <th class="serviceBorder" style="width: 100px;">Category</th>
                <th class="serviceBorder" style="min-width: 40px;"></th>
                <th class="serviceBorder" style="width: 198px;">Name</th>
                <th class="serviceBorder" style="width: 98px;">Price</th>
                <th class="serviceBorder" style="min-width: 40px;"></th>
            <tr>
            <tr class="serviceBorder" style="color: lightgray;">
                <td class="serviceBorder" style="min-width: 40px;">x</th>
                <td class="serviceBorder" style="width: 100px;">Example</th>
                <td class="serviceBorder" style="min-width: 40px;">0</th>
                <td class="serviceBorder" style="width: 198px;">Apple</th>
                <td class="serviceBorder" style="width: 98px;">10.00</th>
                <td class="serviceBorder" style="min-width: 40px;">x</th>
            <tr>
        `;

        if (snapshot.exists()) {

            //CATEGORY - categorySnapshot.val().name
            snapshot.forEach(function (categorySnapshot) {

                document.getElementById("services").innerHTML += `
                    <tr class="serviceBorder">
                        <td id="removeCategory_${categorySnapshot.key}" class="serviceBorder updateButton" style="min-width: 40px; color: red;">x</td>
                        <td class="serviceBorder"
                            style="text-align: center; font-size: 20px; max-width: 40px; min-width: 158px; outline: none;">
                            <input type="text" id="editCategoryName_${categorySnapshot.key}" class="inputBox" value="${categorySnapshot.val().name}">
                        </td>
                        <td colspan="4" style="padding: 0;">
                            <table id="service_${categorySnapshot.key}" style="border-collapse: collapse; margin: -1px; width: calc(100% + 2px);">
                            </table>
                        </td>
                    <tr>
                `;

                setTimeout(() => {

                    // Remove category
                    document.getElementById("removeCategory_" + categorySnapshot.key).addEventListener('click', (e) => {
                        console.log("Remove Category");
                        remove(ref(database, 'services/categories/' + categorySnapshot.key));
                    });

                    // Edit category name
                    document.getElementById("editCategoryName_" + categorySnapshot.key).addEventListener('focusout', (e) => {
                        console.log("Edit Category ", document.getElementById("editCategoryName_" + categorySnapshot.key).value);
                        set(ref(database, 'services/categories/' + categorySnapshot.key + '/name'),
                            document.getElementById("editCategoryName_" + categorySnapshot.key).value
                        );
                    });

                }, 1);

                //Index for counting item quantity
                var index = 0;

                //If the category has child
                if (categorySnapshot.child("items").val() != "") {
                    //ITEM - childSnapshot.val().name, PRICE - childSnapshot.val().price
                    categorySnapshot.child("items").forEach(function (childSnapshot) {

                        //Set to Price at the third <td>
                        document.getElementById("service_" + categorySnapshot.key).innerHTML += `
                            <tr class="serviceBorder">
                                <td class="serviceBorder" style="max-width: 40px; min-width: 40px;">${index + 1}</td>
                                <td class="serviceBorder" style="text-align: center; font-size: 20px; max-width: 40px; min-width: 198px; outline: none;">
                                    <input type="text" id="editItemName_${childSnapshot.key}" class="inputBox" value="${childSnapshot.val().name}">
                                </td>
                                <td class="serviceBorder" style="text-align: center; font-size: 20px; max-width: 40px; min-width: 98px; outline: none;">
                                    <input type="number" id="editItemPrice_${childSnapshot.key}" class="inputBox" style="text-align: right;" value="${childSnapshot.val().price.toFixed(2)}">
                                </td>
                                <td id="removeItem_${childSnapshot.key}" class="serviceBorder updateButton" style="min-width: 40px; color: red;">x</td>
                            </tr>
                        `;

                        setTimeout(() => {

                            // Remove item
                            document.getElementById("removeItem_" + childSnapshot.key).addEventListener('click', (e) => {
                                remove(ref(database, 'services/categories/' + categorySnapshot.key + '/items/' + childSnapshot.key));
                            });

                            // Edit item name
                            document.getElementById("editItemName_" + childSnapshot.key).addEventListener('focusout', (e) => {
                                set(ref(database, 'services/categories/' + categorySnapshot.key + '/items/' + childSnapshot.key + '/name'),
                                    document.getElementById("editItemName_" + childSnapshot.key).value
                                );
                            });

                            // Edit item price
                            document.getElementById("editItemPrice_" + childSnapshot.key).addEventListener('focusout', (e) => {
                                set(ref(database, 'services/categories/' + categorySnapshot.key + '/items/' + childSnapshot.key + '/price'),
                                    Number(document.getElementById("editItemPrice_" + childSnapshot.key).value)
                                );
                            });

                        }, 1);

                        index++;
                    });
                };

                //Click to append item
                document.getElementById("service_" + categorySnapshot.key).innerHTML += `
                    <tr class="serviceBorder">
                        <td colspan="4" style="padding: 0px;">
                            <div id="addItem_${categorySnapshot.key}" class="updateButton" style="color: gray; padding: 6px;">+ ITEM</div>
                        </td>
                    </tr>
                `;

                setTimeout(() => {

                    // Add new item
                    document.getElementById("addItem_" + categorySnapshot.key).addEventListener('click', (e) => {
                        console.log("Add New Item");
                        push(ref(database, 'services/categories/' + categorySnapshot.key + '/items/'), {
                            name: "New Item",
                            price: 0,
                            quantity: ""
                        });
                        document.getElementById("removeCategory_" + categorySnapshot.key).scrollIntoView({ behavior: "smooth" });
                    });

                }, 1);

            });

        };

        //Click to append category
        document.getElementById("services").innerHTML += `
            <tr class="serviceBorder">
                <td colspan="6" style="padding: 0px;">
                    <div id="addCategory" class="updateButton" style="color: gray; padding: 5px;">+ CATEGORY</div>
                </td>
            </tr>
        `;

        // Add new category
        document.getElementById("addCategory").addEventListener('click', (e) => {
            push(ref(database, 'services/categories'), {
                name: "New Category",
                items: ""
            });
            document.getElementById("scroll").scrollTo({
                top: document.getElementById("scroll").scrollHeight,
                behavior: "smooth"
            });
        });

    });

</script>

</html>